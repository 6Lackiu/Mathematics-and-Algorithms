# 三次样条插值 cubic spline

当已知某些点而不知道具体方程时候，通常有两种做法：拟合或者插值。拟合不要求方程通过所有的已知点，讲究神似，就是整体趋势一致。插值则是形似，每个已知点都必会穿过，但是高阶会出现龙格库塔现象，所以一般采用分段插值。Cubic Spline就是一种常用的插值平滑算法，通过一系列的控制点得到一条连续平滑的轨迹。

顾名思义，分段就是把区间 $[a,b]$ 分成 $n$ 个区间 $[(x_0,x_1),(x_1,x_2),...,(x_{n-1},x_n)]$,共有n+1个点，其中两个端点 $x_0=a,x_n=b$ 。三次样条就是说每个小区间的曲线是一个三次方程，三次样条方程满足以下条件：

- 在每个分段小区间 $x_i,x_{i+1}$ 上，$S(x)=S_i(x)$ 都是一个三次方程
- 满足插值条件，即 $S(x_i)=y_i$   $(i=0,1,...,n)$
- 曲线光滑，即 $S(x),S^\prime(x),S^{\prime\prime}(x)$ 连续

则这个三次方程可以构造成如下形式：
$$
y=a_i+b_ix+c_ix^2+d_ix^3
$$
我们称这个方程为三次样条函数 $S_i(x)$ ，从这个方程可以看出每个小区间有四个未知数（$a_i,b_i,c_i,d_i$），共有n个小区间，故共有4n个未知数。要解出这些未知数，我们需要4n个方程。

## 求解

首先根据所有点必须满足插值条件 $S(x_{i})=y_i\quad(i=0,1,...,n)$ ，有
$$
S_i(x_i)=y_i\\S_i(x_{i+1})=y_{i+1}
$$
由此得到2n个方程。

另外，分别除了两个端点，所有内部 n-1 个点的一阶导数连续，即第 i 区间的末点和第 i+1 区间的起点是同一点，所以它们的一阶导数相等，有
$$
S_i^\prime(x_{i+1})=S_{i+1}^\prime(x_{i+1})
$$
这有 n-1 个方程。同理，S(x) 也二阶连续可微：
$$
S_i^\prime\prime(x_{i+1})=S_{i+1}^\prime\prime(x_{i+1})
$$
这也有 n-1 个方程，共 2(n-1) 个方程。再加上之前的 2n 个方程，现在有 4n-2 个方程。

而未知量有 4n 个，这时就需要边界条件来提供最后两个方程，常用的边界条件有以下三种：

1. 自然边界（Natural Spline）：指定端点二阶导数为0，$$S^{\prime\prime}(x_0)=0=S^{\prime\prime}(x_n)$$
2. 固定边界（Clamped Spline）：指定端点一阶导数，这里分别定为A和B，即 $$S^\prime_0(x_0)=A,\quad S^\prime_{n-1}(x_n)=B$$
3. 非扭结边界（Not-A-Knot Spline）：强制第一个插值点的三阶导数值等于第二个点的三阶导数值，最后一个点的三界导数值等于倒数第二个点的三阶导数值，即 $$S_0^{\prime\prime\prime}(x_0)=S_1^{\prime\prime\prime}(x_1)\quad and\quad S_{n-2}^{\prime\prime\prime}(x_{n-1})=S_{n-1}^{\prime\prime\prime}(x_n)$$

## 具体推导

$$
S_i(x)=a_i+b_i(x-x_i)+c_i(x-x_i)^2+d_i(x-x_i)^3\\
S_i^\prime(x)=b_i+2c_i(x-x_i)+3d_i(x-x_i)^2\\
S_i^{\prime\prime}(x)=2c_i+6d_i(x-x_i)
$$

1. 由$$S_i(x_i)=a_i+b_i(x_i-x_i)+c_i(x_i-x_i)^2+d_i(x_i-x_i)^3=y_i$$，可得 $$a_i=y_i$$

2. 用 $$h_i=x_{i+1}-x_i$$ 表示步长，由 $$S_i(x_{i+1})=y_{i+1}$$ 推出：$$a_i+h_ib_i+h_i^2c_i+h_i^3d_i=y_{i+1}$$

3. 由 $$S_i^\prime(x_{i+1})=S_{i+1}^\prime(x_{i+1})$$ 推出：
   $$
   S_i^\prime(x_{i+1})=b_i+2c_i(x_{i+1}-x_i)+3d_i(x_{i+1}-x_i)^2=b_i+2c_ih+3d_ih^2\\
   S_{i+1}^\prime(x_{i+1})=b_{i+1}+2c_i(x_{i+1}-x_{i+1})+3d_i(x_{i+1}-x_{i+1})^2=b_{i+1}
   $$
   可得：$$b_i+2h_ic_i+3h_i^2d_i=b_{i+1}$$

4. 由 $$S_i^{\prime\prime}(x_{i+1})=S_{i+1}^{\prime\prime}(x_{i+1})$$ 推出 $$2c_i+6h_id_i=2c_{i+1}$$

   设 $$m_i=S_i^{\prime\prime}(x_i)=2c_i$$ 则 $$2c_i+6h_id_i=2c_{i+1}$$ 改写为 $$m_i+6h_id_i=m_{i+1}$$，可得：$$d_i=\frac{m_{i+1}-m_i}{6h_i}$$

5. 现在 $$a_i,c_i,d_i$$ 都可以表示成二阶导的关系式，将其代入到 $$a_i+h_ib_i+h_i^2c_i+h_i^3d_i=y_{i+1}$$ 可得 $$b_i=\frac{y_{i+1}-y_i}{h_i}-\frac{h_i}{2}m_i-\frac{h_i}{6}(m_{i+1}-m_i)$$

6. 将 $$a_i,b_i,c_i,d_i$$ 代入 $$b_i+2h_ic_i+3h_i^2d_i=b_{i+1}$$ 可得：
   $$
   h_im_i+2(h_i+h_{i+1})m_{i+1}+h_{i+1}m_{i+2}=6[\frac{y_{i+2}-y_{i+1}}{h_{i+1}}-\frac{y_{i+1}-y_i}{h_i}]
   $$
   这样我们可以构造一个以m为未知数的线性方程组。再选择一种边界条件解方程组即可。

## 算法总结

假定有 $$n+1$$ 个数据节点 $$(x_0,y_0),(x_1,y_1),(x_2,y_2),...,(x_n,y_n)$$

1. 计算步长 $$h_i=x_{i+1}-x_i$$

2. 将数据节点和指定的首位端点条件带入矩阵方程

3. 解矩阵方程，求得二次微分值 $$m_i$$ 。该矩阵为三对角矩阵，常见解法为高斯消元法，可以对系数矩阵进行LU分解，分解为单位下三角矩阵和上三角矩阵。即 $$B=Ax=(LU)x=L(Ux)=Ly$$

4. 计算样条曲线的系数：
   $$
   \begin{align}
   &a_i=y_i\\
   &b_i=\frac{y_{i+1}-y_i}{h_i}-\frac{h_i}{2}m_i-\frac{h_i}{6}(m_{i+1}-m_i)\\
   &c_i=\frac{m_i}{2}\\
   &d_i=\frac{m_{i+1}-m_i}{6h_i}
   \end{align}
   $$

5. 在每个子区间 $$x_i\leq x\leq x_{i+1}$$ 中，创建方程 $$g_i(x)=a_i+b_i(x-x_i)+c_i(x-x_i)^2+d_i(x-x_i)^3$$

